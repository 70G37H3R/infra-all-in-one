---
- name: Install K3s server
  hosts: master
  become: yes
  vars:
    k3s_token_file: /tmp/k3s_token
  tasks:
    - name: Install K3s server
      shell: |
        curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for node token
      wait_for:
        path: /var/lib/rancher/k3s/server/node-token
        timeout: 300

    - name: Read node token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: token_raw

    - name: Save token locally
      copy:
        content: "{{ token_raw.content | b64decode }}"
        dest: "{{ k3s_token_file }}"
      delegate_to: localhost
      become: no

- name: Join worker nodes
  hosts: worker
  become: yes
  vars:
    master_ip: "{{ hostvars['vm-0'].ansible_host }}"
  tasks:
    - name: Read token from control node
      set_fact:
        k3s_token: "{{ lookup('file', '/tmp/k3s_token') }}"

    - name: Install K3s agent
      shell: |
        curl -sfL https://get.k3s.io | \
        K3S_URL=https://{{ master_ip }}:6443 \
        K3S_TOKEN={{ k3s_token }} sh -
      args:
        creates: /usr/local/bin/k3s-agent

- name: Deploy Helm chart on master
  hosts: master
  become: yes
  vars:
    release_name: latency-monitor
    namespace: application
    helm_values_file: values-dev.yaml
  tasks:
    - name: Wait for K3s API to be ready
      wait_for:
        host: localhost
        port: 6443
        timeout: 120

    - name: Wait for all nodes to be Ready
      shell: kubectl get nodes --no-headers | awk '{print $2}' | grep -v Ready
      register: not_ready
      retries: 20
      delay: 15
      until: not_ready.stdout == ""
      changed_when: false
      failed_when: false

    - name: Deploy latency-monitor chart
      shell: |
        helm upgrade --install {{ release_name }} /home/ubuntu/helm \
          --namespace {{ namespace }} \
          --create-namespace \
          -f /home/ubuntu/helm/{{ helm_values_file }} \
          --kubeconfig /etc/rancher/k3s/k3s.yaml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Verify pod is Running
      shell: kubectl get pods -n {{ namespace }} -l app=latency-monitor --no-headers
      register: pod_status
      retries: 12
      delay: 10
      until: "'Running' in pod_status.stdout"
      changed_when: false
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
